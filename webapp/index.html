<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<link rel="stylesheet" href="libs/leaflet.css" />
	<link rel="stylesheet" href="style.css" />

	<script src="libs/jquery-1.12.1.min.js"></script>
	<script src="libs/leaflet.js"></script>
	<script src="libs/typeahead.bundle.min.js"></script>
	<script src="libs/rcolor.js"></script>
	<!-- See https://github.com/sterlingwes/RandomColor -->

	<title>Central Places in Wikipedia</title>

</head>

<body>
	<div id="map"></div>
	<div id="search">
		<input type="text" class="typeahead" placeholder="Search for a place..." />
	</div>

	<script>
		$(document).ready(function() {

			var color = new RColor;

			// setting up the map
			var map = L.map('map').setView([50, 9], 6);;

			L.tileLayer('http://{s}.tile.stamen.com/toner-lite/{z}/{x}/{y}.png', {
				maxZoom: 18,
				attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.',
				id: 'stamen',
				subdomains: ['a', 'b', 'c', 'd']
			}).addTo(map);



			// setting up the search function

			// This effectively turns off tokenization, which is desired in our case:
			function customTokenizer(datum) {
				return datum.page;
			}

			var places = new Bloodhound({
				datumTokenizer: customTokenizer,
				queryTokenizer: Bloodhound.tokenizers.whitespace,
				remote: {
					url: 'search/%QUERY',
					wildcard: '%QUERY',
					filter: function(places) {
						console.log(places);
						// Map the remote source JSON array to a JavaScript object array
						return $.map(places.results, function(p) {
							return {
								page: p.page,
								page_id: p.page_id,
							};
						});
					}
				}
			});

			// passing in `null` for the `options` arguments will result in the default
			// options being used
			$('#search .typeahead').typeahead(null, {
				name: 'places',
				displayKey: 'page',
				source: places
			});

			// Telling the typeahead plugin what to do when a result is selected:
			$('.typeahead').bind('typeahead:select', function(ev, suggestion) {
				getLinksTo(suggestion.page_id);
			});

			function getLinksTo(id) {
				$.get("linksto/" + id, function(place) {
					p = L.geoJson(place, {
						onEachFeature: onEachFeature,
						style: {
							"color": color.get(true)
						}
					})
					p.addTo(map);
					map.fitBounds(p.getBounds());
				})
			};

			function onEachFeature(feature, layer) {

				layer.on('click', function(e) {
					getLinksTo(e.target.feature.properties.fromid);
				});

				layer.on('mouseover', function(e) {
					var popup = L.popup()
						.setLatLng(e.latlng)
						.setContent(e.target.feature.properties.from)
						.openOn(map);
				});

				layer.on('mouseout', function(e) {
					this.closePopup();
				});

			}

		});
	</script>
</body>

</html>
